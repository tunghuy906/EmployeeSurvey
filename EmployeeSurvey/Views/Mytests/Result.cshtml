@model EmployeeSurvey.Models.TestAttempt

@{
    bool hasPendingEssay = Model.Answers.Any(a => a.IsCorrect == null && a.Question.QuestionType == "TextInput");

    ViewData["Title"] = hasPendingEssay ? "Chờ kết quả" : "Kết quả cuối cùng";

    var duration = (Model.StartTime != null && Model.EndTime != null)
        ? Model.EndTime.Value - Model.StartTime.Value
        : TimeSpan.Zero;
}

<div class="container mt-4">
    <h2 class="mb-3 @(hasPendingEssay ? "text-warning" : "text-info")">
        @(hasPendingEssay ? "⏳ Bài kiểm tra đang chờ kết quả" : "📊 Kết quả cuối cùng:") @Model.Test?.Title
    </h2>

    <div class="alert @(hasPendingEssay ? "alert-warning" : "alert-primary")">
        <p>
            <strong>@(hasPendingEssay ? "Điểm tạm thời (chỉ tính trắc nghiệm):" : "Điểm cuối cùng:")</strong>
            @Model.Score / 10
        </p>
        <p><strong>Bắt đầu:</strong> @Model.StartTime?.ToString("HH:mm:ss dd/MM/yyyy")</p>
        <p><strong>Kết thúc:</strong> @Model.EndTime?.ToString("HH:mm:ss dd/MM/yyyy")</p>
        <p><strong>Thời gian làm:</strong> @duration.Minutes phút @duration.Seconds giây</p>
    </div>

    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th style="width:30%">Câu hỏi</th>
                <th style="width:20%">Câu trả lời của bạn</th>
                <th style="width:20%">Đáp án đúng</th>
                <th style="width:10%">Kết quả</th>
                <th style="width:20%">Nhận xét của Admin</th>  @* ✅ thêm cột *@
            </tr>
        </thead>
        <tbody>
            @foreach (var ans in Model.Answers)
            {
                var correctOptions = ans.Question?.QuestionOptions
                .Where(o => o.IsCorrect == true)
                .Select(o => o.Content)
                .ToList() ?? new List<string>();

                <tr class="@(ans.IsCorrect == true ? "table-success"
                              : ans.IsCorrect == false ? "table-danger"
                              : "table-warning")">
                    <td>@ans.Question?.Content</td>
                    <td>
                        @if (!string.IsNullOrEmpty(ans.AnswerText))
                        {
                            <span>@ans.AnswerText</span>
                        }
                        else if (ans.Option != null)
                        {
                            @ans.Option?.Content
                        }
                        else
                        {
                            <span class="text-muted">Chưa trả lời</span>
                        }
                    </td>
                    <td>
                        @if (correctOptions.Any())
                        {
                            @foreach (var opt in correctOptions)
                            {
                                <span class="badge bg-success me-1">@opt</span>
                            }
                        }
                        else
                        {
                            <span class="text-muted">Câu tự luận – chờ Admin</span>
                        }
                    </td>
                    <td>
                        @if (ans.IsCorrect == null)
                        {
                            <span class="text-warning fw-bold">⏳ Chờ chấm</span>
                        }
                        else if (ans.IsCorrect == true)
                        {
                            <span class="text-success fw-bold">✔</span>
                        }
                        else
                        {
                            <span class="text-danger fw-bold">✘</span>
                        }
                    </td>
                    <td>
                        @if (ans.IsGraded && !string.IsNullOrEmpty(ans.AdminComment))
                        {
                            <span class="text-primary">@ans.AdminComment</span>
                        }
                        else
                        {
                            <span class="text-muted">Chưa có nhận xét</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
     <div class="mt-4">
        <h4 class="mt-4">💬 Gửi phản hồi cho Admin</h4>

        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success">@TempData["Success"]</div>
        }

        <form asp-action="Create" asp-controller="Feedbacks" method="post">
            <input type="hidden" name="attemptId" value="@Model.AttemptId" />
            <input type="hidden" name="returnUrl" value="@Url.Action("Result","MyTests", new { id = @Model.AttemptId })" />
            <div class="mb-3">
                <textarea class="form-control" name="content" rows="4" placeholder="Nhập phản hồi của bạn..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Gửi phản hồi</button>
        </form>



    </div>
    <a class="btn btn-secondary mt-3" asp-action="Index">⬅ Quay lại</a>
</div>
